#!/usr/bin/env bash

pushd `dirname $0` > /dev/null
BASE=`pwd`
popd > /dev/null
less_show=false

function query(){
    Q=$1
    str=`curl -s -k --cert $BASE/../resources/tcq/zsh.pem  "https://ark.taobao.org:4430/arkserver/Login.aspx?app=https%3A%2F%2Fwww.alibaba-inc.com%2F&redirectURL=https%3A%2F%2Fwww.alibaba-inc.com%2Fsearch.php%3Fkey%3D${Q}" | grep '<h2' | sed -e 's/.*href="\(.*\)".*/\1/g' | sed -e 's/amp;//'`
    curl -s -k --cert $BASE/../resources/tcq/zsh.pem "$str" | grep -A 22 '<tr height='   | sed -e 's/<\/tr>/|/g' | sed -e 's/<[^<>]*>//g' | sed 's/--//g' | tr "[\n\r]" "\t" | tr "|" "\n"  | column -tx
}

function _less(){
    less_show=true
}

function _help(){
cat <<EOF

tcq ( Teafly Contact Query Tools )
===============================================================

    [name]  --- query the contact by name
    --help  --- for this

===============================================================
EOF
}

case "$1" in
    '--help')
        _help;;
    '--less')
        _less;;
esac

if $less_show ; then
    query "$2" | less
else
    query "$1"
fi
